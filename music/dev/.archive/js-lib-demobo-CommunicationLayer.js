var demobo=demobo||{};
(function(f,q){"function"===typeof define&&define.amd?define(["underscore","backbone"],function(b,c){return q(b||f._,c||f.Backbone)}):q(_,Backbone)})(this,function(f,q){function b(a){Object.apply(this,arguments);f.defaults(a,b.DEFAULT_OPTIONS);this.options=a;this.targets={};this.add(a||{})}function c(a){Object.apply(this,arguments);this.guid=demobo.Utils.getDeviceID();this.type=a?a.type:"";this.channel=a?a.channel:"";this.firebaseUrl=demobo.discovery.options.firebaseUrl+"/communicationLayer"}function h(a){c.apply(this,
arguments);this.target=new Firebase(this.firebaseUrl+"/fb_"+this.channel);this.target.onDisconnect().remove();setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isHost()||this.rpc("_remoteSync",[])}.bind(this),50)}function g(a){c.apply(this,arguments);var d=demobo.discovery.getHostIPAddress(),b=a.port;this.target=new DemoboWebsocket({channel:this.channel,id:this.guid,isHost:this.isHost(),internalIP:d,port:b});this.isHost()&&(demobo.discovery.deviceInfo.port=b);this.target.socketonopen=
function(){this.onConnect&&this.onConnect.call(this);this.isHost()||this.rpc("_remoteSync",[])}.bind(this)}function k(a){c.apply(this,arguments);this.target=new Alljoyn({channel:this.channel,id:this.guid,isHost:this.isHost()});setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isHost()||this.rpc("_remoteSync",[])}.bind(this),1500)}function l(a){c.apply(this,arguments);this.target=window.parent;setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isHost()||this.rpc("_remoteSync",
[])}.bind(this),0)}function m(a){c.apply(this,arguments);this.target=io.connect("127.0.0.1:4000");this.target.emit("create",this.channel);setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isHost()||this.rpc("_remoteSync",[])}.bind(this),50)}function n(a){c.apply(this,arguments);this.target=new WebrtcFirebase({firebaseUrl:this.firebaseUrl,channel:this.channel,guid:this.guid});this.target.onOpen=function(){this.onConnect&&this.onConnect.call(this);this.isHost()||this.rpc("_remoteSync",
[])}.bind(this)}var p={};b.prototype=Object.create(Object.prototype);b.prototype.constructor=b;b.DEFAULT_OPTIONS={};b.prototype.add=function(a,d,c){c=c||function(){};d=d||function(){};if(!a.layers||!a.layers.length)this.remove(a),c.call(this);else{var b=a.layers[0].split(":"),b={type:b[0],port:b[1],channel:a.channelID};if("websocket"==b.type&&demobo.discovery.isHost()){var f=this.getKey(a),e=this.targets[f];if(e&&"websocket"==e.type){delete e.state;e.ping.call(e);return}}switch(b.type){case "webrtc":b.channel=
a.channelID+":"+a.connectionID;e=new n(b);break;case "firebase":e=new h(b);break;case "iframe":e=new l(b);break;case "socketio":e=new m(b);break;case "alljoyn":e=new k(b);break;case "websocket":e=new g(b)}if(e){this.remove(a);1==b.maxConnections&&(this.offMessage(),this.targets={});e.key=this.getKey(a);this.targets[e.key]=e;if(this.onMessageCallback)e.onMessage(this.onMessageCallback);e.onConnect=function(){e.ping.call(e)}.bind(this);e.onSuccess=function(){demobo.discovery.isHost()&&this.syncSet();
d()}.bind(this);setTimeout(function(){e.state||(delete demobo.discovery.deviceInfo.port,a.layers.shift(),this.add(a,d,c))}.bind(this),demobo.discovery.options.layerTimeout)}else console.log("Communication Layer set up fails")}};b.prototype.getKey=function(a){return a.host+a.guest||a.channelID+a.connectionID};b.prototype.remove=function(a){a=this.getKey(a);var d=this.targets[a];d&&(d.offMessage(),delete this.targets[a])};b.prototype.set=function(a,d){a&&(p[a]=d);f(this.targets).map(function(b){b.set(a,
d)})};b.prototype.get=function(a){return p[a]};b.prototype.syncSet=function(){f(p).map(function(a,d){this.set(d,a)}.bind(this))};b.prototype.rpc=function(a,d){f(this.targets).map(function(b){b.rpc(a,d)})};b.prototype.postMessage=function(a){f(this.targets).map(function(d){d.postMessage(a)})};b.prototype.onMessage=function(a){this.onMessageCallback=a;f(this.targets).map(function(d){d.onMessage(a)})};b.prototype.offMessage=function(){f(this.targets).map(function(a){a.offMessage()})};c.prototype=Object.create(Object.prototype);
c.prototype.constructor=c;c.DEFAULT_OPTIONS={};c.prototype.isHost=function(){return demobo.discovery.isHost()};c.prototype.ping=function(){setTimeout(function(){this.postMessage({method:"ping",key:this.key,from:this.guid})}.bind(this),500)};c.prototype.pings=function(a){a--;this.ping();0<a&&setTimeout(function(){this.pings.call(this,a)}.bind(this),100)};c.prototype.set=function(a,d){this.postMessage({method:"set",key:a,value:d,from:this.guid})};c.prototype.rpc=function(a,d){var b=JSON.stringify([a,
d]);this.postMessage({message:b,from:this.guid})};c.prototype.postMessage=function(a){};c.prototype.onMessage=function(a){};c.prototype.offMessage=function(){};c.prototype.handleMessageCallback=function(a,b){a&&this.guid!=a.from&&("ping"==a.method?a.key==this.key&&a.from!=this.guid&&!this.state&&(this.state=1,this.ping.call(this),this.onSuccess()):"set"==a.method?a.key&&(p[a.key]=a.value):a.message&&b(a.message))};h.prototype=Object.create(c.prototype);h.prototype.constructor=h;h.DEFAULT_OPTIONS=
{};h.prototype.postMessage=function(a){this.target.set(a)};h.prototype.onMessage=function(a){this.messageCallback=function(b){(b=b.val())&&this.handleMessageCallback(b,a)}.bind(this);this.target.on("value",this.messageCallback)};h.prototype.offMessage=function(){this.target.off("value",this.messageCallback)};g.prototype=Object.create(c.prototype);g.prototype.constructor=g;g.DEFAULT_OPTIONS={};g.prototype.postMessage=function(a){this.target.send(a)};g.prototype.onMessage=function(a){this.messageCallback=
function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.onMessage(this.messageCallback)};g.prototype.offMessage=function(){this.target.offMessage()};g.prototype.set=function(a,b){};k.prototype=Object.create(c.prototype);k.prototype.constructor=k;k.DEFAULT_OPTIONS={};k.prototype.postMessage=function(a){this.target.send("message",a)};k.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.on("message",this.messageCallback)};
k.prototype.offMessage=function(){this.target.off("message",this.messageCallback)};l.prototype=Object.create(c.prototype);l.prototype.constructor=l;l.DEFAULT_OPTIONS={};l.prototype.postMessage=function(a){this.target.postMessage(a,"*")};l.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b.data,a)}.bind(this);window.addEventListener?window.addEventListener("message",this.messageCallback,!1):window.attachEvent("onmessage",this.messageCallback)};l.prototype.offMessage=
function(){window.removeEventListener?window.removeEventListener("message",this.messageCallback,!1):window.detachEvent("onmessage",this.messageCallback)};m.prototype=Object.create(c.prototype);m.prototype.constructor=m;m.DEFAULT_OPTIONS={};m.prototype.postMessage=function(a){this.target.emit("message",a)};m.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.on("message",this.messageCallback)};m.prototype.offMessage=function(){this.target.off("message",
this.messageCallback)};n.prototype=Object.create(c.prototype);n.prototype.constructor=n;n.DEFAULT_OPTIONS={};n.prototype.postMessage=function(a){this.target.sendMessage&&this.target.sendMessage(a)};n.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.messageCallback=this.messageCallback};n.prototype.offMessage=function(){delete this.target.messageCallback};demobo.CommunicationLayer=b;demobo.communicationLayer=new demobo.CommunicationLayer({});
return demobo.CommunicationLayer});
