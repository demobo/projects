var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null;
navigator.mozGetUserMedia?(webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(b,d){console.log("Attaching media stream");b.mozSrcObject=d;b.play()},reattachMediaStream=function(b,d){console.log("Reattaching media stream");b.mozSrcObject=d.mozSrcObject;b.play()},MediaStream.prototype.getVideoTracks=function(){return[]},
MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(b,d){b.src=webkitURL.createObjectURL(d)},reattachMediaStream=function(b,d){b.src=d.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=
function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable");window.moz=!!navigator.mozGetUserMedia;
function WebrtcFirebase(b){var d=this;this.firebaseUrl=b.firebaseUrl;this.channel=b.channel;this.guid=b.guid;this.init=function(){function b(){try{var a=new n;h=k=e.createDataChannel("test",{reliable:!0});k.onopen=function(a){d.onOpen()};k.onmessage=function(f){if(f.data.size)a.receive(f.data,{});else if(2!=f.data.charCodeAt(0)){var b=JSON.parse(f.data);"file"===b.type?a.receive(f.data,{}):d.messageCallback&&d.messageCallback(b.message)}};k.onclose=function(){console.log("dc1 The Data Channel is Closed")}}catch(f){console.warn("No data channel (pc1)",
f)}}function p(){b();e.createOffer(function(a){e.setLocalDescription(a,function(){})},function(){console.warn("Couldn't create offer")})}function q(){console.log("Datachannel connected")}function r(a){console.log("onRemoveStream",a)}function s(a){}function t(a){}function u(a){}function x(a){c.setRemoteDescription(a);c.createAnswer(function(a){c.setLocalDescription(a)},function(){console.warn("No create answer")})}function n(){var a=[],f="",b=0,d=0;return{receive:function(c,e){if(moz)if(c.size){var g=
new window.FileReader;g.readAsDataURL(c);g.onload=function(a){v.SaveToDisk(a.target.result,f);if(e.onFileReceived)e.onFileReceived(f)}}else g=JSON.parse(c),g.fileName&&(f=g.fileName);if(!moz){c.packets&&(d=b=parseInt(c.packets));if(e.onFileProgress)e.onFileProgress({remaining:b--,length:d,received:d-b});a.push(c.message);if(c.last){v.SaveToDisk(a.join(""),c.name);if(e.onFileReceived)e.onFileReceived(c.name);a=[]}}}}}var g="",l={iceServers:[{url:"stun:23.21.150.121"}]},w={optional:[{DtlsSrtpKeyAgreement:!0}]},
e=new RTCPeerConnection(l,w),k=null;this.pc1=e;var h;d.sendMessage=function(a){return a?(new y).send({message:a}):!1};this.createLocalOffer=p;e.onicecandidate=function(a){null==a.candidate&&(g=JSON.stringify(e.localDescription),d.firebaseRef.set(g))};e.onconnection=q;e.onRemoveStream=r;e.onsignalingstatechange=s;e.oniceconnectionstatechange=t;e.onicegatheringstatechange=u;var c=new RTCPeerConnection(l,w),m=null;this.pc2=c;c.ondatachannel=function(a){var f=new n;h=m=a.channel||a;m.onopen=function(){d.onOpen()};
m.onmessage=function(a){if(a.data.size)f.receive(a.data,{});else{var c=JSON.parse(a.data);"file"===c.type?f.receive(a.data,{}):d.messageCallback&&d.messageCallback(c.message)}};m.onclose=function(){console.log("dc2 The Data Channel is Closed")}};c.onicecandidate=function(a){null==a.candidate&&(g=JSON.stringify(c.localDescription),d.firebaseRef.set(g))};c.onRemoveStream=r;c.onsignalingstatechange=s;c.oniceconnectionstatechange=t;c.onicegatheringstatechange=u;c.onaddstream=function(a){console.log("Got remote stream",
a);var f=new Audio;f.autoplay=!0;attachMediaStream(f,a.stream)};c.onconnection=q;var y=function(a){return{send:function(a){data=moz&&a.file?a.file:JSON.stringify(a);h&&h.send(data)}}},v={SaveToDisk:function(a,c){var b=document.createElement("a");b.href=a;b.target="_blank";b.download=c||a;var d=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});b.dispatchEvent(d);(window.URL||window.webkitURL).revokeObjectURL(b.href)}};this.firebaseRef=new Firebase(this.firebaseUrl+"/wrtc_"+this.channel);
this.hostRef=new Firebase(this.firebaseUrl+"/wrtc_host_"+this.channel);this.guestRef=new Firebase(this.firebaseUrl+"/wrtc_guest_"+this.channel);this.hostRef.once("value",function(a){a.val()?(this.guestRef.set(this.guid),this.guestRef.onDisconnect().remove(),a=_.after(2,function(a){a.val()||this.reset()}.bind(this)),this.hostRef.on("value",a)):(this.hostRef.set(this.guid),this.hostRef.onDisconnect().remove(),a=_.after(2,function(a){(a=a.val())?a!=this.guid&&p():this.reset()}.bind(this)),this.guestRef.on("value",
a))}.bind(this));this.firebaseRef.onDisconnect().remove();l=_.after(2,function(a){if((a=a.val())&&a!=g)"offer"==JSON.parse(a).type?(a=new RTCSessionDescription(JSON.parse(a)),x(a)):(a=new RTCSessionDescription(JSON.parse(a)),e.setRemoteDescription(a))}.bind(this));this.firebaseRef.on("value",l)};this.reset=function(){this.firebaseRef.off();this.hostRef.off();this.guestRef.off();this.firebaseRef.remove();this.hostRef.remove();this.guestRef.remove();delete this.firebaseRef;delete this.hostRef;delete this.guestRef;
delete this.pc1;delete this.pc2;this.init()};this.init()}WebrtcFirebase.prototype=Object.create(Object.prototype);WebrtcFirebase.prototype.constructor=WebrtcFirebase;WebrtcFirebase.DEFAULT_OPTIONS={};
