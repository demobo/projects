var demobo=demobo||{};
(function(){function b(a){Object.apply(this,arguments);_.defaults(a,b.DEFAULT_OPTIONS);this.options=a;k.call(this);this.initDeviceInfo.call(this);l.call(this)}function k(){this.pairingTimeout;this.onPairing=this.options.onPairing;this.onSuccess=function(){this.pairingTimeout&&clearTimeout(this.pairingTimeout);this.options.onSuccess()}.bind(this);this.onFailure=function(){this.pairingTimeout&&clearTimeout(this.pairingTimeout);this.options.onFailure()}.bind(this);this.onTimeout=function(){this.pairingTimeout&&
clearTimeout(this.pairingTimeout);this.options.onTimeout()}.bind(this);this.rootUrl=this.options.firebaseUrl+"/"+this.options.appName+"/";this.pairingUrl=this.options.firebaseUrl+"/"+this.options.appName+"/pairing/";this.enabled=!1;this.pairing={};this.pairing.candidates=[];this.pairing.pairedMembers=[];this.failCallback=this.successCallback=null;this.allowMesh=this.options.allowMesh}function l(){this.keydownHandler=function(a){32==a.keyCode&&setTimeout(this.onPairingTrigger.bind(this),2*m.delay)}.bind(this);
this.onPairHandler=function(a){a=a.val();_.each(a,function(a){this.pairing.candidates.push(a)}.bind(this))}.bind(this)}function f(a){this.removeTimeout&&clearTimeout(this.removeTimeout);this.removeTimeout=setTimeout(function(){this.pairingRef.off("child_added");this.pairingRef.off("value");this.pairingRef.child(this.getDeviceInfo().deviceID).remove()}.bind(this),a)}function g(){var a=_.find(this.pairing.candidates,function(a){return a.deviceID==this.getDeviceInfo().deviceID}.bind(this));a&&(this.pairing.pairedMembers=
this.pairing.candidates.filter(function(c){return c.deviceID==this.getDeviceInfo().deviceID?!1:"code"==this.options.method?c.code&&a.code==c.code:Math.abs(c.serverTime-a.serverTime)<=this.options.paringTolerance}.bind(this)),n.call(this,a));this.pairing.candidates=[]}function n(a){this.roomRef=null;if(1==this.pairing.pairedMembers.length){var c=this.pairing.pairedMembers[0];if(!c.channelID||!a.channelID)if((c.channelID||a.channelID)&&!c.isHost&&!a.isHost)this.allowMesh?p.call(this,a):this.failCallback(c.host?
c.host:a.host);else{c=this.pairing.pairedMembers[0];if(!(a.isHost&&!c.isHost||!a.isHost&&c.isHost)){var b=this.isMobile(),e=this.isAgentMobile(c.userAgent);e&&b||!e&&!b?this.getDeviceInfo().isHost=a.serverTime<=c.serverTime:e&&!b?this.getDeviceInfo().isHost=!0:!e&&b&&(this.getDeviceInfo().isHost=!1)}q.call(this,a)}}else this.roomRef&&this.failCallback("more then one device is pairing")}function p(a){var b="",b=a.channelID?this.pairing.pairedMembers[0].deviceID:a.deviceID;this.getDeviceInfo().roomId=
b;this.roomRef=new Firebase(this.rootUrl+"connected/"+b);this.roomRef.onDisconnect().remove();a.channelID?(a={},a.connectionID=demobo.Utils.guid(),a.host=this.getDeviceInfo().host,a.layers=this.getDeviceInfo().layers,a.channelID=this.getDeviceInfo().channelID,a.hostInfo=this.getDeviceInfo().hostInfo,a=_.compactObject(a),this.roomRef.update(a,function(){this.roomOnValue=function(a){if((a=a.val())&&a.guest)this.roomRef.off("value",this.roomOnValue),this.successCallback(a)}.bind(this);this.roomRef.on("value",
this.roomOnValue)}.bind(this))):h.call(this)}function q(a){var b="",b=this.getDeviceInfo().isHost?this.pairing.pairedMembers[0].deviceID:a.deviceID;this.getDeviceInfo().roomId=b;this.roomRef=new Firebase(this.rootUrl+"connected/"+b);this.roomRef.onDisconnect().remove();this.getDeviceInfo().isHost?(a={},this.getDeviceInfo().channelID||(this.getDeviceInfo().channelID=demobo.Utils.guid()),a.channelID=this.getDeviceInfo().channelID,a.connectionID=demobo.Utils.guid(),a.host=this.getDeviceInfo().deviceID,
a.hostInfo={},a.hostInfo.internalIP=this.getDeviceInfo().internalIP||"",a.hostInfo.userAgent=this.getDeviceInfo().userAgent||"",this.getDeviceInfo().hostInfo=a.hostInfo,a.layers=this.getDeviceInfo().layers,a=_.compactObject(a),this.roomRef.update(a,function(){this.roomOnValue=function(a){if((a=a.val())&&a.guest)this.roomRef.off("value",this.roomOnValue),this.successCallback(a)}.bind(this);this.roomRef.on("value",this.roomOnValue)}.bind(this))):h.call(this)}function h(){this.roomOnValue=function(a){if(a=
a.val())a.layers=_.intersection(a.layers,this.getDeviceInfo().layers),a.guest=this.getDeviceInfo().deviceID,this.roomRef.off("value",this.roomOnValue),this.getDeviceInfo().host=a.host,this.getDeviceInfo().channelID=a.channelID,this.getDeviceInfo().hostInfo=a.hostInfo,a=_.compactObject(a),this.roomRef.update(a),this.successCallback(a)}.bind(this);this.roomRef.on("value",this.roomOnValue)}function r(){this.pairingRef.off("child_added");this.pairingRef.off("value");if("code"==this.options.method&&this.isHost())this.pairingRef.on("child_added",
function(){setTimeout(function(){this.pairingRef.once("value",function(a){this.onPairHandler(a);g.call(this)}.bind(this))}.bind(this),this.options.paringTolerance)}.bind(this));else this.pairingRef.once("child_added",function(){setTimeout(function(){this.pairingRef.once("value",function(a){this.onPairHandler(a);g.call(this)}.bind(this))}.bind(this),this.options.paringTolerance)}.bind(this))}var m=demobo.SimpleBump;b.prototype=Object.create(Object.prototype);b.prototype.constructor=b;b.DEFAULT_OPTIONS=
{firebaseUrl:"https://demobo.firebaseio.com",appName:"discovery",paringTolerance:1E3,dataKeptTime:5E3,mode:"conference",isHost:!1,method:"bump",timeout:6E3,layerTimeout:3E3};b.prototype.initDeviceInfo=function(){this.deviceInfo={deviceID:demobo.Utils.getDeviceID(),platform:navigator.platform,userAgent:navigator.userAgent,layers:this.options.layers||this.getAvailableLayers(),isHost:this.options.isHost,roomId:null,channelID:null,host:null,externalID:demobo_r};this.isMobile()&&window.getIPAddress&&window.getIPAddress(!0,
function(a){_.extend(this.deviceInfo,{internalIP:a})}.bind(this),function(a){console.log(a)});this.options.alwaysOn&&this.deviceInfo.externalID&&setTimeout(function(){this.enable()}.bind(this),0)};b.prototype.enable=function(){this.enabled||(this.enabled=!0,"code"==this.options.method?this.startCodePairing():this.startBumpPairing())};b.prototype.disable=function(){this.enabled&&(this.enabled=!1,"code"==this.options.method?this.endCodePairing():this.endBumpPairing())};b.prototype.search=function(a,
b){"function"===typeof a&&(this.successCallback=_.debounce(a,300,!0));"function"===typeof b&&(this.failCallback=_.debounce(b,300,!0))};b.prototype.getDeviceInfo=function(){return this.deviceInfo};b.prototype.getDeviceID=function(){return this.deviceInfo.deviceID};b.prototype.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)};b.prototype.isAgentMobile=function(a){return a.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)};b.prototype.getAvailableLayers=
function(){var a=["firebase"];a.unshift("websocket:8010");a.unshift("websocket:80");"undefined"!=typeof webrtcDetectedBrowser&&webrtcDetectedBrowser&&a.unshift("webrtc");this.isMobile()&&"undefined"!=typeof Alljoyn&&a.unshift("alljoyn");return a};b.prototype.isHost=function(){return this.getDeviceInfo().isHost};b.prototype.getIPAddress=function(){return this.getDeviceInfo().internalIP};b.prototype.getHostIPAddress=function(){return this.getDeviceInfo().hostInfo.internalIP};b.prototype.isServer=function(){return this.getDeviceInfo().hostInfo.internalIP===
this.getDeviceInfo().internalIP};b.prototype.getRoomID=function(){return this.deviceInfo.externalID.replace(/\./g,"dot")};b.prototype.onPairingTrigger=function(){r.call(this);var a=this.pairingRef;if(a){var b=_.compactObject(this.getDeviceInfo());b.serverTime=Firebase.ServerValue.TIMESTAMP;var d={};d[b.deviceID]=b;d=_.compactObject(d);a.update(d)}this.getDeviceInfo().isHost||f.call(this,this.options.dataKeptTime);this.onPairing&&(this.onPairing(),this.pairingTimeout=setTimeout(this.onTimeout,this.options.timeout))};
b.prototype.startBumpPairing=function(){if(this.deviceInfo.externalID){var a=this.pairingUrl+this.getRoomID();this.pairingRef=new Firebase(a);this.isMobile()?(this.onPairingTriggerRef=this.onPairingTrigger.bind(this),document.addEventListener("volumedownbutton",this.onPairingTriggerRef,!1),document.addEventListener("volumeupbutton",this.onPairingTriggerRef,!1)):window.addEventListener("keydown",this.keydownHandler)}};b.prototype.endBumpPairing=function(){f.call(this,0);this.isMobile()?(document.removeEventListener("volumedownbutton",
this.onPairingTriggerRef,!1),document.removeEventListener("volumeupbutton",this.onPairingTriggerRef,!1)):window.removeEventListener("keydown",this.keydownHandler)};b.prototype.startCodePairing=function(){if(this.deviceInfo.externalID){var a=this.pairingUrl+this.getRoomID();this.pairingRef=new Firebase(a);this.isMobile()&&this.enterCode(Math.random().toString(36).substr(2,4))}};b.prototype.endCodePairing=function(){f.call(this,0)};b.prototype.enterCode=function(a){this.deviceInfo.code=a;this.onPairingTrigger()};
demobo.Discovery=b})();
